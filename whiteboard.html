<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Whiteboard ‚Äî ÏñëÏòÅÌïôÏõê</title>
<style>
/* ===== RESET & BASE ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }

/* ===== CSS VARIABLES ===== */
:root {
  --purple: #7c3aed; --blue: #2563eb; --green: #059669;
  --amber: #d97706; --rose: #e11d48; --cyan: #0891b2;
  --text-primary: #0f172a; --text-secondary: #475569; --text-muted: #94a3b8;
  --surface: #ffffff; --surface-soft: #f8fafc; --surface-muted: #f1f5f9;
  --border: #e2e8f0;
  --slide-bg: #ffffff; --slide-text: #0f172a; --slide-text-secondary: #475569;
  --toolbar-bg: rgba(15, 23, 42, 0.95); --toolbar-text: #e2e8f0;
  --toolbar-active: #7c3aed; --toolbar-hover: rgba(255,255,255,0.1);
  --toolbar-height: 56px; --status-height: 28px; --panel-width: 340px;
  --touch-target: 56px;
}

/* ===== THEMES ===== */
.theme-white { --slide-bg: #ffffff; --slide-text: #0f172a; --slide-text-secondary: #475569; }
.theme-grid {
  --slide-bg: #ffffff; --slide-text: #0f172a; --slide-text-secondary: #475569;
}
.theme-grid #slide-container {
  background-image: linear-gradient(#e8e8e8 1px, transparent 1px), linear-gradient(90deg, #e8e8e8 1px, transparent 1px);
  background-size: 40px 40px;
}
.theme-lined {
  --slide-bg: #fffef5; --slide-text: #1a1a2e; --slide-text-secondary: #555;
}
.theme-lined #slide-container {
  background-image: repeating-linear-gradient(transparent, transparent 39px, #c9bda3 39px, #c9bda3 40px);
}
.theme-dark {
  --slide-bg: #000000; --slide-text: #e0e0e0; --slide-text-secondary: #9e9eb8;
  --border: #2a2a40; --surface: #0a0a12; --surface-soft: #0e0e18; --surface-muted: #141420;
  --text-primary: #e0e0e0; --text-secondary: #8888a0; --text-muted: #555570;
  --purple: #a78bfa;
}
.theme-dark .slide-card { background: rgba(255,255,255,0.04); border-color: #2a2a40; }
.theme-dark .q-option { background: rgba(255,255,255,0.04); border-color: #2a2a40; color: var(--slide-text); }
.theme-dark .q-option:hover { background: rgba(255,255,255,0.08); border-color: #5b5b80; }
.theme-dark .q-option .q-label { color: #a78bfa; }
.theme-dark .q-explanation { background: rgba(255,191,0,0.08); border-left-color: #d97706; color: #fbbf24; }
.theme-dark .grammar-point { background: rgba(255,255,255,0.03); border-color: #2a2a40; }
.theme-dark .grammar-point .example { background: rgba(167,139,250,0.06); }
.theme-dark .ks-block { background: rgba(255,255,255,0.03); border-left-color: #a78bfa; }
.theme-dark .ks-note { background: rgba(167,139,250,0.15); color: #c4b5fd; }
.theme-dark .reveal-label { background: rgba(167,139,250,0.15); border-color: #5b21b6; color: #c4b5fd; }
.theme-dark .vocab-badge { background: rgba(255,255,255,0.06); border-color: #2a2a40; color: #9e9eb8; }
.theme-dark .vocab-badge b { color: #e0e0e0; }
.theme-dark .passage-notes { background: #0a0a12; border-left: 1px solid #2a2a40; }
.theme-dark .passage-notes-header { border-bottom-color: #2a2a40; color: #a78bfa; }
.theme-dark .passage-notes-body textarea { color: #d0d0e0; }
.theme-dark .passage-notes-body textarea::placeholder { color: #555570; }
.theme-dark .passage-resize-handle { background: #2a2a40; }
.theme-dark .passage-resize-handle:hover, .theme-dark .passage-resize-handle.dragging { background: #a78bfa; }
.theme-dark .passage-left::-webkit-scrollbar-thumb { background: #333355; }
.theme-dark .passage-notes-body textarea::-webkit-scrollbar-thumb { background: #333355; }
.theme-dark .slide-header { color: #a78bfa; }
.theme-dark .freeform-content th { border-color: #a78bfa; }
.theme-dark .freeform-content td { border-bottom-color: #2a2a40; }
.theme-dark .reveal-target.text-hl {
  background: linear-gradient(transparent 65%, rgba(250,204,21,0.3) 65%);
}
.theme-dark .nav-zone svg { fill: rgba(255,255,255,0.12); }
.theme-dark #side-panel { background: #0a0a12; border-left-color: #2a2a40; }
.theme-dark .panel-header { border-bottom-color: #2a2a40; color: var(--slide-text); }
.theme-dark .panel-close { color: #9e9eb8; }
.theme-dark .panel-close:hover { background: #141420; }
.theme-dark .panel-section-title { color: #a78bfa; border-bottom-color: #2a2a40; }
.theme-dark .panel-vocab-item { border-bottom-color: #141420; color: #9e9eb8; }
.theme-dark .panel-vocab-word { color: #e0e0e0; }
.theme-sepia { --slide-bg: #f5f0e3; --slide-text: #3d3222; --slide-text-secondary: #6b5d4a; }

/* ===== APP CONTAINER ===== */
#app-container {
  width: 100vw; height: 100vh; display: flex; flex-direction: column;
  background: var(--slide-bg); color: var(--slide-text);
  transition: background 0.3s, color 0.3s; position: relative; overflow: hidden;
}

/* ===== TOOLBAR ===== */
#toolbar {
  height: var(--toolbar-height); background: var(--toolbar-bg); color: var(--toolbar-text);
  display: flex; align-items: center; gap: 4px; padding: 0 12px;
  z-index: 100; flex-shrink: 0; transition: transform 0.3s ease, opacity 0.3s ease;
  user-select: none; -webkit-user-select: none;
}
#toolbar.hidden { transform: translateY(-100%); opacity: 0; pointer-events: none; }
.tool-group { display: flex; align-items: center; gap: 2px; }
.tool-sep { width: 1px; height: 32px; background: rgba(255,255,255,0.15); margin: 0 6px; }
.tool-sep-wide { width: 1px; height: 32px; background: rgba(255,255,255,0.25); margin: 0 10px; }
.tool-btn {
  min-width: var(--touch-target); height: var(--touch-target);
  display: flex; align-items: center; justify-content: center; gap: 6px;
  background: none; border: none; color: var(--toolbar-text); cursor: pointer;
  border-radius: 8px; font-size: 13px; font-weight: 500; padding: 0 10px;
  transition: background 0.15s; position: relative; white-space: nowrap;
}
.tool-btn:hover { background: var(--toolbar-hover); }
.tool-btn.active { background: rgba(124,58,237,0.25); color: #c4b5fd; }
.tool-btn.active::after {
  content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%);
  width: 20px; height: 3px; background: var(--toolbar-active); border-radius: 2px;
}
.tool-btn svg { width: 22px; height: 22px; flex-shrink: 0; }
.color-dot {
  width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid transparent;
  transition: border-color 0.15s, transform 0.15s;
}
.color-dot:hover { transform: scale(1.15); }
.color-dot.active { border-color: #fff; transform: scale(1.2); }
.width-btn {
  width: 40px; height: var(--touch-target); display: flex; align-items: center;
  justify-content: center; cursor: pointer; border: none; background: none;
  border-radius: 8px; transition: background 0.15s;
}
.width-btn:hover { background: var(--toolbar-hover); }
.width-btn.active { background: rgba(124,58,237,0.25); }
.width-line { background: #e2e8f0; border-radius: 4px; }
#slide-counter {
  font-size: 14px; font-weight: 600; min-width: 60px; text-align: center;
  color: #e2e8f0; letter-spacing: 1px;
}
#lesson-nav-wrap { position: relative; margin-left: auto; }
#lesson-title-bar {
  font-size: 12px; color: #94a3b8; max-width: 240px; background: none; border: 1px solid transparent;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;
  padding: 4px 10px; border-radius: 6px; font-family: inherit; transition: all 0.15s;
}
#lesson-title-bar:hover { border-color: rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); }
#lesson-title-bar::after { content: ' ‚ñæ'; font-size: 10px; opacity: 0.5; }
.lnav-dropdown {
  display: none; position: absolute; right: 0; top: 100%; margin-top: 6px;
  background: #1e293b; border: 1px solid #334155; border-radius: 10px;
  min-width: 280px; max-height: 420px; overflow-y: auto; z-index: 3000;
  box-shadow: 0 12px 40px rgba(0,0,0,0.5); padding: 6px;
}
.lnav-dropdown.open { display: block; }
.lnav-group-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #64748b;
  padding: 8px 12px 4px; font-weight: 700;
}
.lnav-item {
  display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 6px;
  cursor: pointer; color: #cbd5e1; font-size: 13px; transition: background 0.1s;
}
.lnav-item:hover { background: rgba(124,58,237,0.15); color: #e2e8f0; }
.lnav-item.active { background: rgba(124,58,237,0.2); color: #a78bfa; font-weight: 600; }
.lnav-item .lnav-slides { font-size: 11px; color: #64748b; margin-left: auto; }
.lnav-empty { padding: 20px; text-align: center; color: #64748b; font-size: 13px; }
.lnav-footer { border-top: 1px solid #334155; padding: 6px; margin-top: 4px; }
.lnav-footer button {
  width: 100%; padding: 8px; border: none; border-radius: 6px; cursor: pointer;
  background: rgba(124,58,237,0.15); color: #a78bfa; font-size: 13px; font-family: inherit;
}
.lnav-footer button:hover { background: rgba(124,58,237,0.25); }

/* ===== SLIDE CONTAINER ===== */
#slide-container {
  flex: 1; position: relative; overflow: hidden;
  background-color: var(--slide-bg); transition: background-color 0.3s;
}
#slide-track {
  display: flex; height: 100%; transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
}
.slide {
  min-width: 100%; height: 100%; padding: 40px 60px; overflow-y: auto;
  display: flex; flex-direction: column;
  scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent;
}
.slide::-webkit-scrollbar { width: 6px; }
.slide::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

/* ===== SLIDE TYPE STYLES ===== */
/* Title */
.slide-title-page {
  justify-content: center; align-items: center; text-align: center; gap: 16px;
}
.slide-title-page h1 { font-size: 2.8em; font-weight: 800; letter-spacing: -1px; line-height: 1.2; }
.slide-title-page .subtitle {
  font-size: 1.3em; color: var(--slide-text-secondary); font-weight: 400;
}
.slide-title-page .accent-line {
  width: 80px; height: 4px; background: var(--purple); border-radius: 2px; margin: 8px 0;
}

/* Passage */
.slide-header { font-size: 0.75em; font-weight: 700; color: var(--purple); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px; }
/* Passage split layout */
.passage-split { display: flex; flex: 1; gap: 0; min-height: 0; overflow: hidden; }
.passage-left { flex: 1; overflow-y: auto; padding-right: 12px; scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
.passage-left::-webkit-scrollbar { width: 6px; }
.passage-left::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
.passage-resize-handle {
  width: 6px; cursor: col-resize; background: var(--border); border-radius: 3px;
  flex-shrink: 0; transition: background 0.2s;
}
.passage-resize-handle:hover, .passage-resize-handle.dragging { background: var(--purple); }
.passage-notes {
  width: 340px; min-width: 180px; max-width: 60%; display: flex; flex-direction: column;
  background: var(--surface-soft); border-radius: 8px; overflow: hidden; flex-shrink: 0;
}
.passage-notes-header {
  padding: 8px 14px; font-size: 0.65em; font-weight: 700; color: var(--purple);
  text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
}
.passage-notes-body {
  flex: 1; padding: 0; overflow: hidden; display: flex;
}
.passage-notes-body textarea {
  flex: 1; border: none; outline: none; resize: none; padding: 12px 14px;
  font-family: inherit; font-size: 0.82em; line-height: 1.7; color: var(--slide-text);
  background: transparent; scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent;
}
.passage-notes-body textarea::-webkit-scrollbar { width: 5px; }
.passage-notes-body textarea::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
.passage-notes-body textarea::placeholder { color: #94a3b8; }
.passage-text { font-size: 1.15em; line-height: 2; word-spacing: 1px; }
.reveal-target {
  position: relative; filter: blur(6px); user-select: none; cursor: default;
  transition: filter 0.5s ease, background 0.5s ease; padding: 2px 0; border-radius: 2px;
  -webkit-box-decoration-break: clone; box-decoration-break: clone;
}
.reveal-target.revealed {
  filter: none; user-select: auto;
}
.reveal-target.text-hl {
  background: linear-gradient(transparent 65%, rgba(254,240,138,0.6) 65%);
  -webkit-box-decoration-break: clone; box-decoration-break: clone;
  background-attachment: scroll;
}
.reveal-label {
  position: absolute; top: -22px; left: 0; font-size: 11px; font-weight: 700;
  color: var(--purple); background: #f5f3ff; padding: 1px 8px; border-radius: 4px;
  border: 1px solid #ddd6fe; white-space: nowrap; opacity: 0; transition: opacity 0.3s;
  pointer-events: none;
}
.reveal-target.revealed .reveal-label { opacity: 1; }

/* Sentence click-to-underline */
.sentence { cursor: pointer; transition: border-bottom 0.2s ease, background 0.2s ease; border-bottom: 2px solid transparent; }
.sentence:hover { border-bottom-color: rgba(124,58,237,0.3); }
.sentence.sentence-active { border-bottom: 3px solid var(--purple); }

/* Vocabulary badge row */
.vocab-badges { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 20px; }
.vocab-badge {
  background: var(--surface-soft); border: 1px solid var(--border); border-radius: 20px;
  padding: 4px 14px; font-size: 0.72em; color: var(--slide-text-secondary);
}
.vocab-badge b { color: var(--slide-text); margin-right: 4px; }

/* Questions */
.question-block { margin-bottom: 32px; max-width: 1000px; }
.question-block .q-num { font-weight: 800; color: var(--purple); font-size: 0.85em; margin-bottom: 6px; }
.question-block .q-text { font-size: 1.1em; font-weight: 600; margin-bottom: 12px; line-height: 1.6; }
.q-options { display: flex; flex-direction: column; gap: 6px; }
.q-option {
  padding: 10px 16px; border: 1.5px solid var(--border); border-radius: 8px;
  font-size: 0.95em; cursor: pointer; transition: all 0.2s; display: flex; align-items: baseline; gap: 10px;
  background: var(--surface-soft);
}
.q-option:hover { border-color: var(--purple); background: #f5f3ff; }
.q-option .q-label { font-weight: 700; color: var(--purple); min-width: 20px; }
.q-option.correct { border-color: var(--green); background: #ecfdf5; }
.q-option.correct .q-label { color: var(--green); }
.q-explanation {
  margin-top: 10px; padding: 12px 16px; background: #fffbeb; border-left: 3px solid var(--amber);
  border-radius: 0 8px 8px 0; font-size: 0.85em; color: #92400e; display: none;
}
.q-explanation.shown { display: block; }

/* Grammar */
.grammar-point {
  margin-bottom: 24px; padding: 20px; border-radius: 12px;
  background: var(--surface-soft); border: 1px solid var(--border); max-width: 1000px;
}
.grammar-point .rule { font-weight: 700; font-size: 1.05em; margin-bottom: 8px; color: var(--purple); }
.grammar-point .example {
  font-size: 1em; line-height: 1.8; padding: 8px 12px; background: rgba(124,58,237,0.04);
  border-radius: 6px; font-family: 'Georgia', serif; letter-spacing: 0.3px;
}
.grammar-point .example .hl { color: var(--rose); font-weight: 700; text-decoration: underline; text-decoration-color: rgba(225,29,72,0.3); }

/* Key Sentence */
.ks-block {
  margin-bottom: 28px; padding: 24px; border-radius: 12px;
  border-left: 4px solid var(--purple); background: var(--surface-soft); max-width: 1000px;
}
.ks-en { font-size: 1.15em; line-height: 1.8; font-weight: 500; margin-bottom: 8px; font-family: 'Georgia', serif; }
.ks-ko { font-size: 0.9em; color: var(--slide-text-secondary); line-height: 1.6; }
.ks-note {
  margin-top: 8px; font-size: 0.78em; color: var(--purple); font-weight: 600;
  background: #f5f3ff; display: inline-block; padding: 2px 10px; border-radius: 12px;
}

/* Freeform */
.freeform-content { max-width: 1100px; line-height: 1.8; }
.freeform-content table { border-collapse: collapse; width: 100%; }
.freeform-content th, .freeform-content td { padding: 10px 14px; border-bottom: 1px solid var(--border); text-align: left; }
.freeform-content th { border-bottom-width: 2px; border-color: var(--purple); }

/* Image */
.slide-image { max-width: 100%; max-height: calc(100% - 80px); object-fit: contain; border-radius: 8px; margin: 0 auto; display: block; }
.image-caption { text-align: center; font-size: 0.8em; color: var(--slide-text-secondary); margin-top: 12px; }

/* Blank */
.slide-blank { justify-content: center; align-items: center; }
.slide-blank::after {
  content: 'ÏûêÏú† ÌïÑÍ∏∞ ÌôîÎ©¥'; font-size: 0.8em; color: var(--text-muted); opacity: 0.4;
  position: absolute; bottom: 60px; pointer-events: none;
}

/* Slide card (reusable container) */
.slide-card {
  background: var(--surface-soft); border: 1px solid var(--border);
  border-radius: 12px; padding: 24px; transition: background 0.3s, border-color 0.3s;
}

/* ===== DRAWING CANVAS ===== */
#drawing-canvas {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  z-index: 10; touch-action: none; cursor: crosshair;
}
#drawing-canvas.mode-navigate { pointer-events: none; cursor: default; }
#drawing-canvas.mode-eraser { cursor: cell; }

/* ===== NAV TOUCH ZONES ===== */
.nav-zone {
  position: absolute; top: 0; width: 12%; height: 100%; z-index: 5;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; opacity: 0; transition: opacity 0.2s;
}
.nav-zone:hover { opacity: 1; }
.nav-zone svg { width: 48px; height: 48px; fill: rgba(0,0,0,0.15); }
#nav-prev { left: 0; }
#nav-next { right: 0; }

/* ===== SIDE PANEL ===== */
#side-panel {
  position: absolute; top: 0; right: 0; width: var(--panel-width); height: 100%;
  background: var(--surface); border-left: 1px solid var(--border);
  z-index: 50; transform: translateX(100%); transition: transform 0.3s ease;
  display: flex; flex-direction: column; box-shadow: -4px 0 20px rgba(0,0,0,0.1);
}
#side-panel.open { transform: translateX(0); }
.panel-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px; border-bottom: 1px solid var(--border); font-weight: 700;
  font-size: 15px; flex-shrink: 0;
}
.panel-close {
  width: 36px; height: 36px; border: none; background: none; cursor: pointer;
  border-radius: 8px; display: flex; align-items: center; justify-content: center;
  color: var(--text-secondary); font-size: 20px;
}
.panel-close:hover { background: var(--surface-muted); }
.panel-body { flex: 1; overflow-y: auto; padding: 16px 20px; }
.panel-section { margin-bottom: 24px; }
.panel-section-title {
  font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
  color: var(--purple); margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border);
}
.panel-vocab-item { display: flex; justify-content: space-between; padding: 6px 0; font-size: 14px; border-bottom: 1px solid var(--surface-muted); }
.panel-vocab-word { font-weight: 600; }
.panel-vocab-meaning { color: var(--text-secondary); }

/* ===== STATUS BAR ===== */
#status-bar {
  height: var(--status-height); background: var(--toolbar-bg); color: var(--text-muted);
  display: flex; align-items: center; padding: 0 16px; gap: 16px;
  font-size: 12px; z-index: 100; flex-shrink: 0; user-select: none;
}
#status-bar span { white-space: nowrap; }

/* ===== BLACKOUT ===== */
#blackout {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #000; z-index: 200; display: none; cursor: pointer;
}
#blackout.active { display: flex; align-items: center; justify-content: center; }
#blackout span { color: #333; font-size: 14px; }

/* ===== LESSON MANAGER MODAL ===== */
#lesson-modal {
  position: fixed; inset: 0; z-index: 300; display: none;
  align-items: center; justify-content: center;
  background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
}
#lesson-modal.open { display: flex; }
.lm-dialog {
  background: var(--surface, #fff); color: var(--slide-text, #0f172a);
  border-radius: 16px; width: 720px; max-width: 92vw; max-height: 88vh;
  display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  overflow: hidden;
}
.lm-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 24px; border-bottom: 1px solid var(--border, #e2e8f0);
  font-weight: 800; font-size: 16px;
}
.lm-close {
  width: 36px; height: 36px; border: none; background: none; cursor: pointer;
  border-radius: 8px; font-size: 22px; color: var(--text-secondary, #475569);
  display: flex; align-items: center; justify-content: center;
}
.lm-close:hover { background: var(--surface-muted, #f1f5f9); }
.lm-body { flex: 1; overflow-y: auto; padding: 20px 24px; }
.lm-tabs { display: flex; gap: 4px; margin-bottom: 16px; }
.lm-tab {
  padding: 8px 18px; border: none; border-radius: 8px; cursor: pointer;
  font-size: 13px; font-weight: 600; background: var(--surface-muted, #f1f5f9);
  color: var(--text-secondary, #475569); transition: all 0.15s;
}
.lm-tab.active { background: var(--purple, #7c3aed); color: #fff; }
.lm-tab:hover:not(.active) { background: var(--border, #e2e8f0); }
.lm-section { display: none; }
.lm-section.active { display: block; }
.lm-label {
  font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
  color: var(--purple, #7c3aed); margin-bottom: 8px;
}
.lm-textarea {
  width: 100%; height: 280px; border: 1.5px solid var(--border, #e2e8f0); border-radius: 10px;
  padding: 14px; font-family: 'SF Mono', 'Consolas', monospace; font-size: 12.5px;
  line-height: 1.6; resize: vertical; background: var(--surface-soft, #f8fafc);
  color: var(--slide-text, #0f172a); outline: none; tab-size: 2;
}
.lm-textarea:focus { border-color: var(--purple, #7c3aed); }
.lm-hint { font-size: 11.5px; color: var(--text-muted, #94a3b8); margin-top: 8px; line-height: 1.5; }
.lm-actions { display: flex; gap: 8px; margin-top: 16px; }
.lm-btn {
  padding: 10px 24px; border: none; border-radius: 8px; cursor: pointer;
  font-size: 13px; font-weight: 700; transition: all 0.15s;
}
.lm-btn-primary { background: var(--purple, #7c3aed); color: #fff; }
.lm-btn-primary:hover { filter: brightness(1.15); }
.lm-btn-danger { background: #fee2e2; color: #dc2626; }
.lm-btn-danger:hover { background: #fecaca; }
.lm-btn-secondary { background: var(--surface-muted, #f1f5f9); color: var(--text-secondary, #475569); }
.lm-btn-secondary:hover { background: var(--border, #e2e8f0); }
.lm-list { list-style: none; }
.lm-list li {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 14px; border-bottom: 1px solid var(--border, #e2e8f0);
  border-radius: 8px; margin-bottom: 4px; transition: background 0.15s;
}
.lm-list li:hover { background: var(--surface-soft, #f8fafc); }
.lm-list-info { flex: 1; cursor: pointer; }
.lm-list-title { font-weight: 700; font-size: 14px; }
.lm-list-meta { font-size: 11px; color: var(--text-muted, #94a3b8); margin-top: 2px; }
.lm-list-actions { display: flex; gap: 4px; }
.lm-list-btn {
  width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer;
  font-size: 14px; display: flex; align-items: center; justify-content: center;
  background: transparent; color: var(--text-muted, #94a3b8); transition: all 0.15s;
}
.lm-list-btn:hover { background: var(--surface-muted, #f1f5f9); color: var(--text-primary, #0f172a); }
.lm-list-btn.delete:hover { background: #fee2e2; color: #dc2626; }
.lm-empty { text-align: center; padding: 40px 20px; color: var(--text-muted, #94a3b8); font-size: 14px; }

/* ===== SORT BAR & MULTI-SELECT ===== */
.lm-sort-bar {
  display: flex; align-items: center; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;
}
.lm-sort-label { font-size: 11px; color: var(--text-muted, #94a3b8); font-weight: 600; margin-right: 2px; }
.lm-sort-btn {
  padding: 4px 12px; border: 1.5px solid var(--border, #e2e8f0); border-radius: 20px;
  font-size: 12px; font-weight: 600; cursor: pointer; background: none;
  color: var(--text-secondary, #475569); transition: all 0.15s;
}
.lm-sort-btn.active { border-color: var(--purple, #7c3aed); color: var(--purple, #7c3aed); background: rgba(124,58,237,0.07); }
.lm-sort-btn:hover:not(.active) { border-color: var(--text-muted, #94a3b8); }
.lm-list-check {
  width: 17px; height: 17px; border-radius: 4px; border: 1.5px solid var(--border, #e2e8f0);
  margin-right: 10px; cursor: pointer; flex-shrink: 0; appearance: none; -webkit-appearance: none;
  background: var(--surface, #fff); transition: all 0.15s; position: relative;
}
.lm-list-check:checked { background: var(--purple, #7c3aed); border-color: var(--purple, #7c3aed); }
.lm-list-check:checked::after { content: '‚úì'; position: absolute; top: -2px; left: 2px; font-size: 12px; color: white; font-weight: 900; }
.lm-list li.lm-selected { background: rgba(124,58,237,0.07) !important; }
.lm-bulk-bar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px; border-top: 1px solid var(--border, #e2e8f0);
  margin-top: 8px; border-radius: 10px; background: var(--surface-soft, #f8fafc);
}
.lm-bulk-bar.hidden { display: none; }
.lm-bulk-count { font-size: 13px; font-weight: 600; color: var(--text-secondary, #475569); }
.lm-bulk-actions { display: flex; gap: 8px; }
.theme-dark .lm-sort-btn { border-color: #2a2a40; color: #9e9eb8; }
.theme-dark .lm-sort-btn.active { border-color: #a78bfa; color: #a78bfa; background: rgba(167,139,250,0.08); }
.theme-dark .lm-list-check { background: #0a0a12; border-color: #2a2a40; }
.theme-dark .lm-list li.lm-selected { background: rgba(167,139,250,0.08) !important; }
.theme-dark .lm-bulk-bar { background: #141420; border-top-color: #2a2a40; }
.lm-toast {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
  background: #065f46; color: #ecfdf5; padding: 10px 24px; border-radius: 10px;
  font-size: 13px; font-weight: 600; z-index: 350; opacity: 0; transition: opacity 0.3s;
  pointer-events: none;
}
.lm-toast.show { opacity: 1; }

/* ===== LESSON DROPZONE ===== */
.lm-dropzone {
  border: 2px dashed var(--border, #e2e8f0); border-radius: 12px;
  padding: 28px 20px; text-align: center; cursor: pointer;
  transition: all 0.2s; margin-bottom: 4px; position: relative;
  background: var(--surface-soft, #f8fafc);
}
.lm-dropzone:hover, .lm-dropzone.drag-over {
  border-color: var(--purple, #7c3aed);
  background: rgba(124,58,237,0.05);
}
.lm-dropzone.drag-over { border-style: solid; }
.lm-dropzone input[type=file] {
  position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
}
.lm-dropzone-icon { font-size: 30px; margin-bottom: 6px; }
.lm-dropzone-text { font-size: 14px; font-weight: 700; color: var(--text-secondary, #475569); }
.lm-dropzone-sub { font-size: 12px; color: var(--text-muted, #94a3b8); margin-top: 3px; }
.lm-or {
  display: flex; align-items: center; gap: 12px;
  margin: 14px 0 10px; color: var(--text-muted, #94a3b8); font-size: 12px;
}
.lm-or::before, .lm-or::after { content: ''; flex: 1; height: 1px; background: var(--border, #e2e8f0); }
.theme-dark .lm-dropzone { background: #0a0a12; border-color: #2a2a40; }
.theme-dark .lm-dropzone:hover, .theme-dark .lm-dropzone.drag-over { border-color: #a78bfa; background: rgba(167,139,250,0.06); }

.theme-dark .lm-dialog { background: #0e0e18; }
.theme-dark .lm-textarea { background: #0a0a12; border-color: #2a2a40; color: #d0d0e0; }
.theme-dark .lm-textarea:focus { border-color: #a78bfa; }
.theme-dark .lm-close:hover { background: #141420; }
.theme-dark .lm-tab { background: #141420; color: #9e9eb8; }
.theme-dark .lm-tab:hover:not(.active) { background: #1a1a2e; }
.theme-dark .lm-btn-secondary { background: #141420; color: #9e9eb8; }
.theme-dark .lm-btn-danger { background: rgba(220,38,38,0.15); }
.theme-dark .lm-list li:hover { background: #141420; }
.theme-dark .lm-list-btn:hover { background: #1a1a2e; color: #e0e0e0; }

/* ===== MISC ===== */
.sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
@media (max-width: 800px) {
  .slide { padding: 24px 20px; }
  #toolbar { padding: 0 6px; gap: 2px; }
  .tool-btn { min-width: 44px; height: 44px; padding: 0 6px; font-size: 11px; }
}
</style>
</head>
<body>

<div id="app-container" class="theme-white">
  <!-- TOOLBAR -->
  <div id="toolbar">
    <!-- Drawing tools -->
    <div class="tool-group">
      <button class="tool-btn active" data-tool="navigate" title="Ìè¨Ïù∏ÌÑ∞ (Esc)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></svg>
      </button>
      <button class="tool-btn" data-tool="pen" title="Ìéú">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
      </button>
      <button class="tool-btn" data-tool="highlighter" title="ÌòïÍ¥ëÌéú">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 11-6 6v3h9l3-3"/><path d="m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/></svg>
      </button>
      <button class="tool-btn" data-tool="eraser" title="ÏßÄÏö∞Í∞ú">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>
      </button>
      <button class="tool-btn" data-tool="clear" title="Ï†ÑÏ≤¥ ÏÇ≠Ï†ú">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
      </button>
    </div>
    <div class="tool-sep"></div>
    <!-- Colors -->
    <div class="tool-group" id="color-group">
      <div class="color-dot active" data-color="#e11d48" style="background:#e11d48" title="Îπ®Í∞ï"></div>
      <div class="color-dot" data-color="#2563eb" style="background:#2563eb" title="ÌååÎûë"></div>
      <div class="color-dot" data-color="#059669" style="background:#059669" title="Ï¥àÎ°ù"></div>
      <div class="color-dot" data-color="#0f172a" style="background:#0f172a" title="Í≤ÄÏ†ï"></div>
      <div class="color-dot" data-color="#eab308" style="background:#eab308" title="ÎÖ∏Îûë"></div>
    </div>
    <div class="tool-sep"></div>
    <!-- Pen width -->
    <div class="tool-group" id="width-group">
      <button class="width-btn" data-width="2" title="ÏñáÍ≤å"><div class="width-line" style="width:16px;height:2px"></div></button>
      <button class="width-btn active" data-width="4" title="Î≥¥ÌÜµ"><div class="width-line" style="width:16px;height:4px"></div></button>
      <button class="width-btn" data-width="8" title="ÍµµÍ≤å"><div class="width-line" style="width:16px;height:8px"></div></button>
    </div>
    <div class="tool-sep-wide"></div>
    <!-- Navigation -->
    <div class="tool-group">
      <button class="tool-btn" id="btn-prev" title="Ïù¥Ï†Ñ (‚Üê)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
      <span id="slide-counter">1 / 1</span>
      <button class="tool-btn" id="btn-next" title="Îã§Ïùå (‚Üí)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
      </button>
    </div>
    <div class="tool-sep-wide"></div>
    <!-- View controls -->
    <div class="tool-group">
      <button class="tool-btn" id="btn-font-up" title="Í∏ÄÍº¥ ÌÅ¨Í≤å (+)">A+</button>
      <button class="tool-btn" id="btn-font-down" title="Í∏ÄÍº¥ ÏûëÍ≤å (-)">A-</button>
      <button class="tool-btn" id="btn-bg" title="Î∞∞Í≤Ω Ï†ÑÌôò (B)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 3v18"/></svg>
      </button>
      <button class="tool-btn" id="btn-reveal" title="Reveal (R)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
      </button>
      <button class="tool-btn" id="btn-reveal-middle" title="Ï§ëÍ∞Ñ Í≥µÍ∞ú" style="font-weight:800;color:#fbbf24;font-size:14px">2-F</button>
      <button class="tool-btn" id="btn-panel" title="ÏûêÎ£å Ìå®ÎÑê">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M15 3v18"/></svg>
      </button>
      <button class="tool-btn" id="btn-fullscreen" title="Ï†ÑÏ≤¥ÌôîÎ©¥ (F11)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
      </button>
      <button class="tool-btn" id="btn-lesson-mgr" title="ÏàòÏóÖ Í¥ÄÎ¶¨ (L)" style="font-size:15px">üìö</button>
    </div>
    <div id="lesson-nav-wrap">
      <button id="lesson-title-bar" title="ÏàòÏóÖ Ï†ÑÌôò ‚ñæ"></button>
      <div id="lesson-nav-dropdown" class="lnav-dropdown"></div>
    </div>
  </div>

  <!-- SLIDE AREA -->
  <div id="slide-container">
    <div id="slide-track"></div>
    <canvas id="drawing-canvas" class="mode-navigate"></canvas>
    <!-- Nav touch zones -->
    <div class="nav-zone" id="nav-prev" title="Ïù¥Ï†Ñ">
      <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
    </div>
    <div class="nav-zone" id="nav-next" title="Îã§Ïùå">
      <svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
    </div>
  </div>

  <!-- SIDE PANEL -->
  <div id="side-panel">
    <div class="panel-header">
      <span>ÏûêÎ£å</span>
      <button class="panel-close" id="panel-close-btn">&times;</button>
    </div>
    <div class="panel-body" id="panel-body"></div>
  </div>

  <!-- STATUS BAR -->
  <div id="status-bar">
    <span id="status-slide">Slide 1/1</span>
    <span id="status-tool">Ìè¨Ïù∏ÌÑ∞</span>
    <span id="status-lesson"></span>
  </div>

  <!-- BLACKOUT -->
  <div id="blackout"><span>ÌôîÎ©¥ÏùÑ ÌÑ∞ÏπòÌïòÍ±∞ÎÇò ÏïÑÎ¨¥ ÌÇ§Î•º ÎàÑÎ•¥ÏÑ∏Ïöî</span></div>

  <!-- LESSON MANAGER MODAL -->
  <div id="lesson-modal">
    <div class="lm-dialog">
      <div class="lm-header">
        <span>üìö ÏàòÏóÖ Í¥ÄÎ¶¨</span>
        <button class="lm-close" id="lm-close">&times;</button>
      </div>
      <div class="lm-body">
        <div class="lm-tabs">
          <button class="lm-tab active" data-lm-tab="load">ÏÉà ÏàòÏóÖ Î∂ôÏó¨ÎÑ£Í∏∞</button>
          <button class="lm-tab" data-lm-tab="saved">Ï†ÄÏû•Îêú ÏàòÏóÖ</button>
          <button class="lm-tab" data-lm-tab="edit">ÌòÑÏû¨ ÏàòÏóÖ Ìé∏Ïßë</button>
        </div>
        <!-- TAB: Î∂ôÏó¨ÎÑ£Í∏∞ -->
        <div class="lm-section active" id="lm-sec-load">
          <div class="lm-label">JS ÌååÏùº ÏóÖÎ°úÎìú</div>
          <div class="lm-dropzone" id="lm-dropzone">
            <input type="file" id="lm-file-input" accept=".js">
            <div class="lm-dropzone-icon">üìÇ</div>
            <div class="lm-dropzone-text">JS ÌååÏùºÏùÑ Ïó¨Í∏∞Ïóê ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠Ìï¥ÏÑú ÏÑ†ÌÉù</div>
            <div class="lm-dropzone-sub">ClaudeÍ∞Ä ÏÉùÏÑ±Ìïú lessons/*.js ÌååÏùº ‚Äî ÎìúÎ°≠ÌïòÎ©¥ Ï¶âÏãú Ï†ÄÏû•Îê©ÎãàÎã§</div>
          </div>
          <div class="lm-or">ÎòêÎäî ÌÖçÏä§Ìä∏Î°ú Î∂ôÏó¨ÎÑ£Í∏∞</div>
          <div class="lm-label">ÏàòÏóÖ Îç∞Ïù¥ÌÑ∞ Î∂ôÏó¨ÎÑ£Í∏∞</div>
          <textarea class="lm-textarea" id="lm-paste" placeholder='ClaudeÍ∞Ä ÎßåÎì§Ïñ¥Ï§Ä ÏΩîÎìúÎ•º Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî.

window.LESSON_DATA = {
  title: "...",
  slides: [...]
};

ÎòêÎäî JSON ÌòïÏãùÎèÑ Îê©ÎãàÎã§:
{
  "title": "...",
  "slides": [...]
}'></textarea>
          <div class="lm-hint">
            üí° Claude CoworkÏóê PDFÎ•º Ïò¨Î¶¨Í≥† "ÏñëÏòÅ ÌôîÏù¥Ìä∏Î≥¥Îìú JSÎ°ú ÎßåÎì§Ïñ¥Ï§ò"ÎùºÍ≥† ÌïòÎ©¥ ÏûêÎèô ÏÉùÏÑ±Îê©ÎãàÎã§.<br>
            &nbsp;&nbsp;&nbsp;‚Ä¢ <code>lessons/*.js</code> ÌååÏùº ÏßÅÏ†ë ÎìúÎ°≠ OK (LESSON_LIBRARY ÌòïÏãù)<br>
            &nbsp;&nbsp;&nbsp;‚Ä¢ <code>window.LESSON_DATA = {...}</code> ÌòïÏãù OK<br>
            &nbsp;&nbsp;&nbsp;‚Ä¢ ÏàúÏàò JSON <code>{...}</code> ÌòïÏãù OK
          </div>
          <div class="lm-actions">
            <button class="lm-btn lm-btn-primary" id="lm-btn-load">Î°úÎìú & Ï†ÄÏû•</button>
          </div>
        </div>
        <!-- TAB: Ï†ÄÏû•Îêú ÏàòÏóÖ Î™©Î°ù -->
        <div class="lm-section" id="lm-sec-saved">
          <div class="lm-sort-bar">
            <span class="lm-sort-label">Ï†ïÎ†¨</span>
            <button class="lm-sort-btn active" data-sort="date-desc">ÏµúÏã†Ïàú</button>
            <button class="lm-sort-btn" data-sort="date-asc">Ïò§ÎûòÎêúÏàú</button>
            <button class="lm-sort-btn" data-sort="name-asc">Ïù¥Î¶ÑÏàú</button>
            <button class="lm-sort-btn" data-sort="slides-desc">Ïä¨ÎùºÏù¥Îìú Ïàò</button>
          </div>
          <ul class="lm-list" id="lm-saved-list"></ul>
          <div class="lm-bulk-bar hidden" id="lm-bulk-bar">
            <span class="lm-bulk-count" id="lm-bulk-count">0Í∞ú ÏÑ†ÌÉùÎê®</span>
            <div class="lm-bulk-actions">
              <button class="lm-btn lm-btn-secondary" id="lm-bulk-deselect">ÏÑ†ÌÉù Ìï¥Ï†ú</button>
              <button class="lm-btn lm-btn-danger" id="lm-bulk-delete">ÏÑ†ÌÉù ÏÇ≠Ï†ú</button>
            </div>
          </div>
        </div>
        <!-- TAB: ÌòÑÏû¨ ÏàòÏóÖ Ìé∏Ïßë -->
        <div class="lm-section" id="lm-sec-edit">
          <div class="lm-label">ÌòÑÏû¨ ÏàòÏóÖ Îç∞Ïù¥ÌÑ∞ (JSON)</div>
          <textarea class="lm-textarea" id="lm-edit" style="height:360px"></textarea>
          <div class="lm-hint">‚ö†Ô∏è JSON Î¨∏Î≤ïÏù¥ ÌãÄÎ¶¨Î©¥ Î°úÎìú Ïã§Ìå®Ìï©ÎãàÎã§. ÏàòÏ†ï ÌõÑ Ï†ÄÏû• Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî.</div>
          <div class="lm-actions">
            <button class="lm-btn lm-btn-primary" id="lm-btn-save-edit">ÏàòÏ†ï Ï†ÄÏû• & Ï†ÅÏö©</button>
            <button class="lm-btn lm-btn-secondary" id="lm-btn-copy">Î≥µÏÇ¨</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="lm-toast" id="lm-toast"></div>
</div>

<!-- LESSON LIBRARY: ÏàòÏóÖ ÌååÏùºÎì§ (lessons/ Ìè¥ÎçîÏùò .js ÌååÏùº Ï∂îÍ∞Ä) -->
<script>window.LESSON_LIBRARY = [];</script>
<script src="lessons/sample_lesson.js"></script>
<script src="lessons/ch03_gist.js"></script>
<script src="lessons/ch04_claim.js"></script>
<script src="lessons/march25_types.js"></script>

<script>
// ===== STATE =====
const STATE = {
  currentSlide: 0,
  totalSlides: 0,
  drawingMode: 'navigate',
  penColor: '#e11d48',
  penWidth: 4,
  isDrawing: false,
  currentStroke: null,
  slideDrawings: {},
  undoStack: {},
  revealState: {},
  toolbarVisible: true,
  toolbarTimer: null,
  panelOpen: false,
  fullscreen: false,
  fontSize: 32,
  bgIndex: 0,
  lesson: null,
  blackout: false,
  textHighlighting: false
};

const BACKGROUNDS = ['white', 'grid', 'lined', 'dark', 'sepia'];
const TOOL_LABELS = { navigate: 'Ìè¨Ïù∏ÌÑ∞', pen: 'Ìéú', highlighter: 'ÌòïÍ¥ëÌéú', eraser: 'ÏßÄÏö∞Í∞ú' };
const OPTION_LABELS = ['‚ë†', '‚ë°', '‚ë¢', '‚ë£', '‚ë§'];

// ===== DOM REFS =====
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);
const app = $('#app-container');
const toolbar = $('#toolbar');
const slideTrack = $('#slide-track');
const slideContainer = $('#slide-container');
const canvas = $('#drawing-canvas');
const ctx = canvas.getContext('2d');
const sidePanel = $('#side-panel');
const blackoutEl = $('#blackout');

// ===== INITIALIZATION =====
function init() {
  if (!STATE.lesson) STATE.lesson = window.LESSON_DATA || createFallbackLesson();
  const s = STATE.lesson.settings || {};
  STATE.fontSize = s.defaultFontSize || 32;
  STATE.bgIndex = BACKGROUNDS.indexOf(s.defaultBg || 'white');
  if (STATE.bgIndex < 0) STATE.bgIndex = 0;
  applyBackground();
  slideContainer.style.fontSize = STATE.fontSize + 'px';

  renderAllSlides();
  initPassageReveals();
  renderPanel();
  updateUI();
  setupCanvas();
  setupEvents();

  $('#lesson-title-bar').textContent = STATE.lesson.title || '';
  $('#status-lesson').textContent = STATE.lesson.title || '';
}

function createFallbackLesson() {
  return {
    title: 'Empty Lesson',
    settings: {},
    slides: [{ type: 'blank' }],
    resources: []
  };
}

// ===== SLIDE RENDERERS =====
function renderAllSlides() {
  slideTrack.innerHTML = '';
  const slides = STATE.lesson.slides || [];
  STATE.totalSlides = slides.length;
  slides.forEach((data, i) => {
    const el = document.createElement('div');
    el.className = 'slide';
    el.dataset.index = i;
    const renderer = RENDERERS[data.type] || RENDERERS.freeform;
    renderer(el, data, i);
    slideTrack.appendChild(el);
  });
}

// Wrap text into sentence-level spans for click-to-underline
function wrapSentences(escapedText) {
  if (!escapedText || !escapedText.trim()) return escapedText;
  // Split at sentence boundaries: .!? + space + uppercase (no lookbehind for old browser compat)
  var result = escapedText.replace(/([.!?])\s+(?=[A-Z])/g, '$1</span> <span class="sentence">');
  return '<span class="sentence">' + result + '</span>';
}

const RENDERERS = {
  title(el, data) {
    el.classList.add('slide-title-page');
    el.innerHTML = `
      <h1>${esc(data.title || '')}</h1>
      <div class="accent-line"></div>
      ${data.subtitle ? `<div class="subtitle">${esc(data.subtitle)}</div>` : ''}
    `;
  },

  passage(el, data, idx) {
    let html = `<div class="slide-header">${esc(data.title || 'Passage')}</div>`;
    let content = data.content || '';
    const sortedReveals = [...(data.reveals || [])].sort((a, b) => a.start - b.start);
    let result = '';
    let lastEnd = 0;
    sortedReveals.forEach((r, ri) => {
      result += wrapSentences(esc(content.slice(lastEnd, r.start)));
      result += `<span class="reveal-target" data-reveal-idx="${ri}" data-slide="${idx}">` +
        `<span class="reveal-label">${esc(r.label || '')}</span>` +
        wrapSentences(esc(content.slice(r.start, r.end))) + `</span>`;
      lastEnd = r.end;
    });
    result += wrapSentences(esc(content.slice(lastEnd)));

    let vocabHtml = '';
    if (data.vocabulary && data.vocabulary.length) {
      vocabHtml += '<div class="vocab-badges">';
      data.vocabulary.forEach(v => {
        vocabHtml += `<span class="vocab-badge"><b>${esc(v.word)}</b> ${esc(v.meaning)}</span>`;
      });
      vocabHtml += '</div>';
    }

    html += `<div class="passage-split">` +
      `<div class="passage-left"><div class="passage-text">${result}</div>${vocabHtml}</div>` +
      `<div class="passage-resize-handle" data-slide="${idx}"></div>` +
      `<div class="passage-notes" data-slide="${idx}">` +
        `<div class="passage-notes-header"><span>Notes</span></div>` +
        `<div class="passage-notes-body">` +
          `<textarea placeholder="ÏàòÏóÖ Ï§ë Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." data-notes-slide="${idx}"></textarea>` +
        `</div>` +
      `</div>` +
    `</div>`;

    el.innerHTML = html;
  },

  questions(el, data, idx) {
    let html = `<div class="slide-header">${esc(data.title || 'Questions')}</div>`;
    (data.items || []).forEach((q, qi) => {
      html += `<div class="question-block" data-q="${qi}" data-slide="${idx}">`;
      html += `<div class="q-num">Q${qi + 1}</div>`;
      html += `<div class="q-text">${esc(q.question || '')}</div>`;
      html += '<div class="q-options">';
      (q.options || []).forEach((opt, oi) => {
        html += `<div class="q-option" data-answer="${q.answer}" data-opt="${oi}" data-slide="${idx}" data-q="${qi}">` +
          `<span class="q-label">${OPTION_LABELS[oi] || (oi+1)}</span> ${esc(opt)}</div>`;
      });
      html += '</div>';
      if (q.explanation) {
        html += `<div class="q-explanation" data-slide="${idx}" data-q="${qi}">${esc(q.explanation)}</div>`;
      }
      html += '</div>';
    });
    el.innerHTML = html;

    // Click handler for answer reveal
    setTimeout(() => {
      el.querySelectorAll('.q-option').forEach(opt => {
        opt.addEventListener('click', () => {
          if (STATE.drawingMode !== 'navigate') return;
          const answer = parseInt(opt.dataset.answer);
          const optIdx = parseInt(opt.dataset.opt);
          const block = opt.closest('.question-block');
          // Highlight correct answer
          block.querySelectorAll('.q-option').forEach((o, i) => {
            if (i === answer) o.classList.add('correct');
          });
          // Show explanation
          const expl = block.querySelector('.q-explanation');
          if (expl) expl.classList.add('shown');
        });
      });
    }, 0);
  },

  grammar(el, data) {
    let html = `<div class="slide-header">${esc(data.title || 'Grammar')}</div>`;
    (data.points || []).forEach(p => {
      let ex = esc(p.example || '');
      if (p.highlight) {
        const hlEsc = esc(p.highlight);
        ex = ex.replace(new RegExp(`(${escRegex(hlEsc)})`, 'gi'), '<span class="hl">$1</span>');
      }
      html += `<div class="grammar-point">
        <div class="rule">${esc(p.rule || '')}</div>
        <div class="example">${ex}</div>
      </div>`;
    });
    el.innerHTML = html;
  },

  keysentence(el, data) {
    let html = `<div class="slide-header">${esc(data.title || 'Key Sentences')}</div>`;
    (data.sentences || []).forEach(s => {
      html += `<div class="ks-block">
        <div class="ks-en">${esc(s.en || '')}</div>
        <div class="ks-ko">${esc(s.ko || '')}</div>
        ${s.grammar_note ? `<span class="ks-note">${esc(s.grammar_note)}</span>` : ''}
      </div>`;
    });
    el.innerHTML = html;
  },

  freeform(el, data) {
    el.innerHTML = `<div class="slide-header">${esc(data.title || '')}</div>
      <div class="freeform-content">${data.html || ''}</div>`;
  },

  image(el, data) {
    el.innerHTML = `<div class="slide-header">${esc(data.title || '')}</div>
      <img class="slide-image" src="${esc(data.src || '')}" alt="${esc(data.caption || '')}"
        style="object-fit:${data.fit || 'contain'}" onerror="this.alt='Ïù¥ÎØ∏ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§'">
      ${data.caption ? `<div class="image-caption">${esc(data.caption)}</div>` : ''}`;
  },

  blank(el) {
    el.classList.add('slide-blank');
  }
};

// ===== SIDE PANEL =====
function renderPanel() {
  const body = $('#panel-body');
  const resources = STATE.lesson.resources || [];
  if (!resources.length) {
    body.innerHTML = '<p style="color:var(--text-muted);font-size:14px">Îì±Î°ùÎêú ÏûêÎ£åÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
    return;
  }
  let html = '';
  resources.forEach(r => {
    html += `<div class="panel-section"><div class="panel-section-title">${esc(r.label || '')}</div>`;
    if (r.type === 'vocabulary' && r.items) {
      r.items.forEach(v => {
        html += `<div class="panel-vocab-item"><span class="panel-vocab-word">${esc(v.word)}</span><span class="panel-vocab-meaning">${esc(v.meaning)}</span></div>`;
      });
    } else if (r.type === 'html') {
      html += r.content || '';
    } else if (r.type === 'image') {
      html += `<img src="${esc(r.src || '')}" style="max-width:100%;border-radius:8px" alt="">`;
    }
    html += '</div>';
  });
  body.innerHTML = html;
}

// ===== NAVIGATION =====
function goToSlide(index) {
  if (index < 0 || index >= STATE.totalSlides) return;
  saveNotes();
  STATE.currentSlide = index;
  slideTrack.style.transform = `translateX(-${index * 100}%)`;
  redrawCanvas(index);
  updateUI();
}
function nextSlide() { goToSlide(STATE.currentSlide + 1); }
function prevSlide() { goToSlide(STATE.currentSlide - 1); }

// ===== REVEAL =====
// Ï¥àÍ∏∞Ìôî: Ï≤´ 2Í∞ú reveal targetÎßå ÏûêÎèô Í≥µÍ∞ú, ÏòàÏãú Îì± ÎÇòÎ®∏ÏßÄÎäî Î∏îÎü¨
function initPassageReveals() {
  STATE.lesson.slides.forEach((data, idx) => {
    if (data.type !== 'passage') return;
    const targets = slideTrack.querySelectorAll(`.reveal-target[data-slide="${idx}"]`);
    if (targets.length === 0) return;
    // Ï≤´ 2Í∞úÎßå Í≥µÍ∞ú (ÏòàÏãú Î∂ÄÎ∂Ñ Ìè¨Ìï® ÎÇòÎ®∏ÏßÄÎäî Î∏îÎü¨ Ïú†ÏßÄ)
    for (let i = 0; i < Math.min(2, targets.length); i++) {
      targets[i].classList.add('revealed');
    }
  });
}

function revealNext() {
  const idx = STATE.currentSlide;
  const targets = slideTrack.querySelectorAll(`.reveal-target[data-slide="${idx}"]`);
  // ÏïÑÏßÅ Í≥µÍ∞ú Ïïà Îêú Îã§Ïùå ÌÉÄÍ≤üÏùÑ Ï∞æÏïÑÏÑú Í≥µÍ∞ú
  for (let i = 0; i < targets.length; i++) {
    if (!targets[i].classList.contains('revealed')) {
      targets[i].classList.add('revealed');
      return;
    }
  }
}

// 2-F Î≤ÑÌäº: Î∏îÎü¨Îêú Ï§ëÍ∞Ñ Î∂ÄÎ∂Ñ Ï†ÑÏ≤¥ Í≥µÍ∞ú
function revealMiddle() {
  const idx = STATE.currentSlide;
  const targets = slideTrack.querySelectorAll(`.reveal-target[data-slide="${idx}"]:not(.revealed)`);
  targets.forEach(t => t.classList.add('revealed'));
}

// ===== PASSAGE NOTES RESIZE =====
function initPassageResize() {
  const handles = slideTrack.querySelectorAll('.passage-resize-handle');
  handles.forEach(handle => {
    handle.addEventListener('pointerdown', startResize);
  });
}

function startResize(e) {
  e.preventDefault();
  e.stopPropagation();
  const handle = e.currentTarget;
  handle.classList.add('dragging');
  const split = handle.closest('.passage-split');
  const notes = split.querySelector('.passage-notes');
  const startX = e.clientX;
  const startWidth = notes.offsetWidth;

  function onMove(ev) {
    ev.preventDefault();
    const delta = startX - ev.clientX;
    const newW = Math.max(180, Math.min(split.offsetWidth * 0.6, startWidth + delta));
    notes.style.width = newW + 'px';
  }
  function onUp() {
    handle.classList.remove('dragging');
    document.removeEventListener('pointermove', onMove);
    document.removeEventListener('pointerup', onUp);
  }
  document.addEventListener('pointermove', onMove);
  document.addEventListener('pointerup', onUp);
}

// Ïä¨ÎùºÏù¥Îìú Í∞Ñ ÎÖ∏Ìä∏ ÎÇ¥Ïö© Î≥¥Ï°¥
const notesStore = {};
function saveNotes() {
  slideTrack.querySelectorAll('textarea[data-notes-slide]').forEach(ta => {
    const key = ta.dataset.notesSlide;
    if (ta.value) notesStore[key] = ta.value;
  });
}
function restoreNotes() {
  slideTrack.querySelectorAll('textarea[data-notes-slide]').forEach(ta => {
    const key = ta.dataset.notesSlide;
    if (notesStore[key]) ta.value = notesStore[key];
  });
}

function revealAll() {
  const idx = STATE.currentSlide;
  const targets = slideTrack.querySelectorAll(`.reveal-target[data-slide="${idx}"]`);
  targets.forEach(t => t.classList.add('revealed'));
}

// ===== DRAWING ENGINE =====
function setupCanvas() {
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
}

function resizeCanvas() {
  const rect = slideContainer.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  redrawCanvas(STATE.currentSlide);
}

function getPointerPos(e) {
  const rect = canvas.getBoundingClientRect();
  return { x: e.clientX - rect.left, y: e.clientY - rect.top, pressure: e.pressure || 0.5 };
}

function onPointerDown(e) {
  if (STATE.drawingMode === 'navigate') return;
  if (STATE.drawingMode === 'clear') return;
  e.preventDefault();
  const pos = getPointerPos(e);

  if (STATE.drawingMode === 'eraser') {
    handleEraser(pos.x, pos.y);
    return;
  }

  // Text-following highlighter: if highlighter tool over passage text, apply CSS highlight
  if (STATE.drawingMode === 'highlighter') {
    const hitEl = hitTestThrough(e.clientX, e.clientY);
    if (hitEl) {
      const rt = hitEl.closest('.reveal-target.revealed');
      if (rt) {
        rt.classList.add('text-hl');
        STATE.textHighlighting = true;
        return;
      }
      const ptxt = hitEl.closest('.passage-text');
      if (ptxt) {
        STATE.textHighlighting = true;
        return;
      }
    }
  }

  STATE.textHighlighting = false;
  STATE.isDrawing = true;
  STATE.currentStroke = {
    points: [pos],
    color: STATE.penColor,
    width: STATE.drawingMode === 'highlighter' ? STATE.penWidth * 5 : STATE.penWidth,
    tool: STATE.drawingMode,
    slideIndex: STATE.currentSlide
  };
}

function onPointerMove(e) {
  // Text-following highlighter: highlight reveal targets as pointer drags over them
  if (STATE.textHighlighting && STATE.drawingMode === 'highlighter') {
    e.preventDefault();
    const hitEl = hitTestThrough(e.clientX, e.clientY);
    if (hitEl) {
      const rt = hitEl.closest('.reveal-target.revealed');
      if (rt) rt.classList.add('text-hl');
    }
    return;
  }
  if (!STATE.isDrawing) return;
  e.preventDefault();
  const pos = getPointerPos(e);
  STATE.currentStroke.points.push(pos);
  const pts = STATE.currentStroke.points;
  if (pts.length >= 2) {
    drawSegment(pts[pts.length - 2], pts[pts.length - 1], STATE.currentStroke);
  }
}

function onPointerUp(e) {
  if (STATE.textHighlighting) { STATE.textHighlighting = false; return; }
  if (!STATE.isDrawing) return;
  STATE.isDrawing = false;
  const idx = STATE.currentSlide;
  if (!STATE.slideDrawings[idx]) STATE.slideDrawings[idx] = [];
  STATE.slideDrawings[idx].push(STATE.currentStroke);
  STATE.undoStack[idx] = [];
  STATE.currentStroke = null;
}

function drawSegment(from, to, stroke) {
  ctx.save();
  if (stroke.tool === 'highlighter') {
    ctx.globalAlpha = 0.25;
    ctx.lineCap = 'square';
    ctx.lineJoin = 'miter';
  } else {
    ctx.globalAlpha = 1.0;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
  }
  ctx.strokeStyle = stroke.color;
  ctx.lineWidth = stroke.width;
  ctx.beginPath();
  ctx.moveTo(from.x, from.y);
  ctx.lineTo(to.x, to.y);
  ctx.stroke();
  ctx.restore();
}

function drawFullStroke(stroke) {
  if (stroke.points.length < 2) return;
  for (let i = 1; i < stroke.points.length; i++) {
    drawSegment(stroke.points[i - 1], stroke.points[i], stroke);
  }
}

function redrawCanvas(slideIndex) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const strokes = STATE.slideDrawings[slideIndex] || [];
  strokes.forEach(s => drawFullStroke(s));
}

function handleEraser(x, y) {
  const strokes = STATE.slideDrawings[STATE.currentSlide];
  if (!strokes || !strokes.length) return;
  const THRESHOLD = 20;
  for (let i = strokes.length - 1; i >= 0; i--) {
    for (const pt of strokes[i].points) {
      if (Math.hypot(pt.x - x, pt.y - y) < THRESHOLD) {
        const removed = strokes.splice(i, 1)[0];
        if (!STATE.undoStack[STATE.currentSlide]) STATE.undoStack[STATE.currentSlide] = [];
        STATE.undoStack[STATE.currentSlide].push(removed);
        redrawCanvas(STATE.currentSlide);
        return;
      }
    }
  }
}

function clearDrawing() {
  const idx = STATE.currentSlide;
  const strokes = STATE.slideDrawings[idx];
  if (strokes && strokes.length) {
    STATE.undoStack[idx] = strokes.slice();
    STATE.slideDrawings[idx] = [];
    redrawCanvas(idx);
  }
}

function undo() {
  const idx = STATE.currentSlide;
  const strokes = STATE.slideDrawings[idx];
  if (!strokes || !strokes.length) return;
  const removed = strokes.pop();
  if (!STATE.undoStack[idx]) STATE.undoStack[idx] = [];
  STATE.undoStack[idx].push(removed);
  redrawCanvas(idx);
}

function redo() {
  const idx = STATE.currentSlide;
  const stack = STATE.undoStack[idx];
  if (!stack || !stack.length) return;
  const restored = stack.pop();
  if (!STATE.slideDrawings[idx]) STATE.slideDrawings[idx] = [];
  STATE.slideDrawings[idx].push(restored);
  redrawCanvas(idx);
}

// ===== TOOL MANAGEMENT =====
function setTool(tool) {
  if (tool === 'clear') {
    clearDrawing();
    return;
  }
  STATE.drawingMode = tool;
  canvas.className = tool === 'navigate' ? 'mode-navigate' : (tool === 'eraser' ? 'mode-eraser' : '');

  $$('[data-tool]').forEach(b => b.classList.toggle('active', b.dataset.tool === tool));
  updateUI();
}

function setColor(color) {
  STATE.penColor = color;
  $$('.color-dot').forEach(d => d.classList.toggle('active', d.dataset.color === color));
  if (STATE.drawingMode === 'navigate' || STATE.drawingMode === 'eraser') {
    setTool('pen');
  }
}

function setPenWidth(w) {
  STATE.penWidth = parseInt(w);
  $$('.width-btn').forEach(b => b.classList.toggle('active', b.dataset.width === String(w)));
}

// ===== BACKGROUND & FONT =====
function cycleBackground() {
  STATE.bgIndex = (STATE.bgIndex + 1) % BACKGROUNDS.length;
  applyBackground();
}

function applyBackground() {
  BACKGROUNDS.forEach(b => app.classList.remove('theme-' + b));
  app.classList.add('theme-' + BACKGROUNDS[STATE.bgIndex]);
}

function adjustFontSize(delta) {
  STATE.fontSize = Math.max(18, Math.min(60, STATE.fontSize + delta));
  slideContainer.style.fontSize = STATE.fontSize + 'px';
}

// ===== FULLSCREEN =====
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    app.requestFullscreen().catch(() => {});
    STATE.fullscreen = true;
  } else {
    document.exitFullscreen().catch(() => {});
    STATE.fullscreen = false;
  }
}

// ===== PANEL =====
function togglePanel() {
  STATE.panelOpen = !STATE.panelOpen;
  sidePanel.classList.toggle('open', STATE.panelOpen);
}

// ===== BLACKOUT =====
function toggleBlackout() {
  STATE.blackout = !STATE.blackout;
  blackoutEl.classList.toggle('active', STATE.blackout);
}

// ===== TOOLBAR AUTO-HIDE =====
function resetToolbarTimer() {
  if (!STATE.toolbarVisible) {
    toolbar.classList.remove('hidden');
    STATE.toolbarVisible = true;
  }
  clearTimeout(STATE.toolbarTimer);
  STATE.toolbarTimer = setTimeout(() => {
    if (STATE.drawingMode !== 'navigate') return;
    toolbar.classList.add('hidden');
    STATE.toolbarVisible = false;
  }, 6000);
}

// ===== UI UPDATE =====
function updateUI() {
  $('#slide-counter').textContent = `${STATE.currentSlide + 1} / ${STATE.totalSlides}`;
  $('#status-slide').textContent = `Slide ${STATE.currentSlide + 1}/${STATE.totalSlides}`;
  const toolName = TOOL_LABELS[STATE.drawingMode] || STATE.drawingMode;
  const extra = STATE.drawingMode === 'pen' || STATE.drawingMode === 'highlighter' ? ` (${STATE.penWidth}px)` : '';
  $('#status-tool').textContent = toolName + extra;
}

// ===== EVENTS =====
function setupEvents() {
  // Pointer events on canvas
  canvas.addEventListener('pointerdown', onPointerDown);
  canvas.addEventListener('pointermove', onPointerMove);
  canvas.addEventListener('pointerup', onPointerUp);
  canvas.addEventListener('pointerleave', onPointerUp);

  // Keyboard
  document.addEventListener('keydown', handleKey);

  // Toolbar buttons
  $$('[data-tool]').forEach(b => b.addEventListener('click', () => setTool(b.dataset.tool)));
  $$('.color-dot').forEach(d => d.addEventListener('click', () => setColor(d.dataset.color)));
  $$('.width-btn').forEach(b => b.addEventListener('click', () => setPenWidth(b.dataset.width)));

  $('#btn-prev').addEventListener('click', prevSlide);
  $('#btn-next').addEventListener('click', nextSlide);
  $('#btn-font-up').addEventListener('click', () => adjustFontSize(2));
  $('#btn-font-down').addEventListener('click', () => adjustFontSize(-2));
  $('#btn-bg').addEventListener('click', cycleBackground);
  $('#btn-reveal').addEventListener('click', revealNext);
  $('#btn-reveal-middle').addEventListener('click', revealMiddle);
  $('#btn-panel').addEventListener('click', togglePanel);
  $('#btn-fullscreen').addEventListener('click', toggleFullscreen);
  $('#panel-close-btn').addEventListener('click', togglePanel);

  // Nav touch zones
  $('#nav-prev').addEventListener('click', prevSlide);
  $('#nav-next').addEventListener('click', nextSlide);

  // Blackout dismiss
  blackoutEl.addEventListener('click', toggleBlackout);

  // Toolbar hover reset
  toolbar.addEventListener('mouseenter', resetToolbarTimer);
  toolbar.addEventListener('touchstart', resetToolbarTimer, { passive: true });
  slideContainer.addEventListener('mousemove', resetToolbarTimer);

  // Passage click: sentence underline + reveal highlight
  slideTrack.addEventListener('click', (e) => {
    if (STATE.drawingMode !== 'navigate') return;
    // Sentence click-to-underline (works on revealed text)
    const sent = e.target.closest('.sentence');
    if (sent) {
      const parentRt = sent.closest('.reveal-target');
      if (!parentRt || parentRt.classList.contains('revealed')) {
        sent.classList.toggle('sentence-active');
        e.stopPropagation();
        return;
      }
    }
    // Reveal target click
    const rt = e.target.closest('.reveal-target');
    if (!rt) return;
    if (STATE.lesson.settings && STATE.lesson.settings.revealMode === 'individual') {
      rt.classList.toggle('revealed');
      return;
    }
    if (rt.classList.contains('revealed')) {
      rt.classList.toggle('text-hl');
    }
  });

  // Notes textarea: ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Ï∞®Îã® (Ïä¨ÎùºÏù¥Îìú Ï†ÑÌôò Î∞©ÏßÄ)
  slideTrack.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'TEXTAREA') e.stopPropagation();
  }, true);

  // Passage notes resize handles
  initPassageResize();
  restoreNotes();

  // Fullscreen change
  document.addEventListener('fullscreenchange', () => {
    STATE.fullscreen = !!document.fullscreenElement;
  });
}

function handleKey(e) {
  // Blackout: any key dismisses
  if (STATE.blackout && e.key !== 'F5') {
    e.preventDefault();
    toggleBlackout();
    return;
  }

  const key = e.key;

  // Navigation
  if (key === 'PageDown' || key === 'ArrowRight' || (key === ' ' && !e.shiftKey)) {
    e.preventDefault(); nextSlide(); resetToolbarTimer(); return;
  }
  if (key === 'PageUp' || key === 'ArrowLeft') {
    e.preventDefault(); prevSlide(); resetToolbarTimer(); return;
  }

  // Reveal
  if (key === 'r' || key === 'R') {
    if (!e.ctrlKey && !e.metaKey) { e.preventDefault(); revealNext(); return; }
  }
  // Reveal all
  if (key === 'a' || key === 'A') {
    if (e.shiftKey && !e.ctrlKey) { e.preventDefault(); revealAll(); return; }
  }

  // Background
  if ((key === 'b' || key === 'B') && !e.ctrlKey && !e.metaKey) {
    e.preventDefault(); cycleBackground(); return;
  }

  // Blackout
  if (key === '.') { e.preventDefault(); toggleBlackout(); return; }

  // Font size
  if (key === '=' || key === '+') { e.preventDefault(); adjustFontSize(2); return; }
  if (key === '-' || key === '_') { e.preventDefault(); adjustFontSize(-2); return; }

  // Undo/Redo
  if ((e.ctrlKey || e.metaKey) && (key === 'z' || key === 'Z')) {
    e.preventDefault();
    if (e.shiftKey) redo(); else undo();
    return;
  }

  // Escape
  if (key === 'Escape') {
    if ($('#lesson-modal').classList.contains('open')) { closeLessonModal(); return; }
    if (STATE.panelOpen) { togglePanel(); return; }
    if (STATE.drawingMode !== 'navigate') { setTool('navigate'); return; }
    if (STATE.fullscreen) { toggleFullscreen(); return; }
  }

  // Fullscreen
  if (key === 'F11') { e.preventDefault(); toggleFullscreen(); return; }
  if (key === 'F5') { e.preventDefault(); toggleFullscreen(); return; }

  // Lesson Manager
  if ((key === 'l' || key === 'L') && !e.ctrlKey && !e.metaKey) {
    e.preventDefault(); openLessonModal(); return;
  }

  // Tool shortcuts
  if (key === '1') { setTool('navigate'); return; }
  if (key === '2') { setTool('pen'); return; }
  if (key === '3') { setTool('highlighter'); return; }
  if (key === '4') { setTool('eraser'); return; }

  resetToolbarTimer();
}

// ===== UTILITIES =====
// Hit-test through the canvas overlay to find elements underneath
function hitTestThrough(x, y) {
  canvas.style.pointerEvents = 'none';
  const el = document.elementFromPoint(x, y);
  canvas.style.pointerEvents = '';
  return el;
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
function escRegex(s) {
  return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// ===== LESSON MANAGER =====
const STORAGE_KEY = 'wb_lessons';
const CURRENT_KEY = 'wb_current';

function getLessonStore() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch { return {}; }
}
function saveLessonStore(store) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); } catch(e) { /* localStorage unavailable */ }
}
function setCurrentLessonId(id) {
  try { localStorage.setItem(CURRENT_KEY, id); } catch(e) { /* localStorage unavailable */ }
}
function getCurrentLessonId() {
  try { return localStorage.getItem(CURRENT_KEY) || ''; } catch(e) { return ''; }
}

function parseLessonInput(text) {
  text = text.trim();
  // 1) LESSON_LIBRARY.push() IIFE ÌòïÏãù (ClaudeÍ∞Ä ÏÉùÏÑ±Ìïú lessons/*.js ÌååÏùº)
  if (text.includes('LESSON_LIBRARY') && text.includes('push')) {
    try {
      const sandbox = { LESSON_LIBRARY: [] };
      const fn = new Function('window', text);
      fn(sandbox);
      if (sandbox.LESSON_LIBRARY.length > 0) return sandbox.LESSON_LIBRARY[0];
    } catch(e) {}
  }
  // 2) window.LESSON_DATA = ... wrapper
  const m = text.match(/(?:window\.)?LESSON_DATA\s*=\s*([\s\S]+?);?\s*$/);
  if (m) text = m[1];
  // 3) Try JSON parse
  try { return JSON.parse(text); } catch {}
  // 4) Try eval as JS object literal
  try { return (new Function('return (' + text + ')'))(); } catch {}
  return null;
}

function loadLessonData(data) {
  STATE.lesson = data;
  const s = data.settings || {};
  STATE.fontSize = s.defaultFontSize || 32;
  STATE.bgIndex = BACKGROUNDS.indexOf(s.defaultBg || 'white');
  if (STATE.bgIndex < 0) STATE.bgIndex = 0;
  STATE.currentSlide = 0;
  STATE.slideDrawings = {};
  STATE.undoStack = {};
  STATE.revealState = {};
  Object.keys(notesStore).forEach(k => delete notesStore[k]);
  // Close side panel if open
  if (STATE.panelOpen) { sidePanel.classList.remove('open'); STATE.panelOpen = false; }
  applyBackground();
  slideContainer.style.fontSize = STATE.fontSize + 'px';
  renderAllSlides();
  initPassageReveals();
  renderPanel();
  setupCanvas();
  initPassageResize();
  restoreNotes();
  slideTrack.style.transform = 'translateX(0)';
  updateUI();
  $('#lesson-title-bar').textContent = data.title || '';
  $('#status-lesson').textContent = data.title || '';
}

function lmToast(msg) {
  const t = $('#lm-toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

function openLessonModal() {
  const modal = $('#lesson-modal');
  modal.classList.add('open');
  // Refresh saved list
  renderSavedList();
  // Fill edit tab with current lesson
  $('#lm-edit').value = JSON.stringify(STATE.lesson, null, 2);
  // Activate first tab
  activateLmTab('load');
}

function closeLessonModal() {
  $('#lesson-modal').classList.remove('open');
}

function activateLmTab(tab) {
  $$('.lm-tab').forEach(t => t.classList.toggle('active', t.dataset.lmTab === tab));
  $$('.lm-section').forEach(s => s.classList.remove('active'));
  $(`#lm-sec-${tab}`).classList.add('active');
}

let lmSortMode = 'date-desc';

function renderSavedList() {
  const store = getLessonStore();
  const list = $('#lm-saved-list');

  // Ï†ïÎ†¨ Î≤ÑÌäº active ÏÉÅÌÉú ÎèôÍ∏∞Ìôî
  $$('.lm-sort-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.sort === lmSortMode));

  const keys = Object.keys(store);
  if (!keys.length) {
    list.innerHTML = '<div class="lm-empty">Ï†ÄÏû•Îêú ÏàòÏóÖÏù¥ ÏóÜÏäµÎãàÎã§.<br>üìÇ ÏÉà ÏàòÏóÖ ÌÉ≠ÏóêÏÑú JS ÌååÏùºÏùÑ ÎìúÎ°≠ÌïòÍ±∞ÎÇò Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî.</div>';
    $('#lm-bulk-bar').classList.add('hidden');
    return;
  }

  // Ï†ïÎ†¨
  keys.sort((a, b) => {
    const ia = store[a], ib = store[b];
    switch (lmSortMode) {
      case 'date-asc':   return (ia.savedAt || 0) - (ib.savedAt || 0);
      case 'name-asc':   return ((ia.data && ia.data.title) || a).localeCompare((ib.data && ib.data.title) || b, 'ko');
      case 'slides-desc': return ((ib.data && ib.data.slides && ib.data.slides.length) || 0) - ((ia.data && ia.data.slides && ia.data.slides.length) || 0);
      default:           return (ib.savedAt || 0) - (ia.savedAt || 0);
    }
  });

  const currentId = getCurrentLessonId();
  list.innerHTML = keys.map(k => {
    const item = store[k];
    const d = item.savedAt ? new Date(item.savedAt) : null;
    const dateStr = d ? `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}` : '';
    const slides = (item.data && item.data.slides && item.data.slides.length) || 0;
    const isCurrent = k === currentId;
    return `<li${isCurrent ? ' style="background:rgba(124,58,237,0.08)"' : ''}>
      <input type="checkbox" class="lm-list-check" data-check-id="${esc(k)}" title="ÏÑ†ÌÉù">
      <div class="lm-list-info" data-lesson-id="${esc(k)}">
        <div class="lm-list-title">${isCurrent ? '‚ñ∂ ' : ''}${esc((item.data && item.data.title) || k)}</div>
        <div class="lm-list-meta">${item.source === 'library' ? 'üìÅ ' : ''}${slides}Í∞ú Ïä¨ÎùºÏù¥Îìú ¬∑ ${dateStr}</div>
      </div>
      <div class="lm-list-actions">
        <button class="lm-list-btn delete" data-delete-id="${esc(k)}" title="ÏÇ≠Ï†ú">üóë</button>
      </div>
    </li>`;
  }).join('');

  // Ï≤¥ÌÅ¨Î∞ïÏä§ ‚Üí bulk bar Ïó∞Îèô
  function updateBulkBar() {
    const checked = list.querySelectorAll('.lm-list-check:checked');
    const bar = $('#lm-bulk-bar');
    if (checked.length > 0) {
      bar.classList.remove('hidden');
      $('#lm-bulk-count').textContent = `${checked.length}Í∞ú ÏÑ†ÌÉùÎê®`;
    } else {
      bar.classList.add('hidden');
    }
    list.querySelectorAll('.lm-list-check').forEach(cb =>
      cb.closest('li').classList.toggle('lm-selected', cb.checked)
    );
  }
  list.querySelectorAll('.lm-list-check').forEach(cb =>
    cb.addEventListener('change', updateBulkBar)
  );

  // Click to load
  list.querySelectorAll('.lm-list-info').forEach(el => {
    el.addEventListener('click', () => {
      const id = el.dataset.lessonId;
      const item = getLessonStore()[id];
      if (item && item.data) {
        loadLessonData(item.data);
        setCurrentLessonId(id);
        closeLessonModal();
        lmToast('‚úÖ "' + (item.data.title || id) + '" Î°úÎìú ÏôÑÎ£å');
      }
    });
  });

  // Í∞úÎ≥Ñ ÏÇ≠Ï†ú
  list.querySelectorAll('[data-delete-id]').forEach(el => {
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      const id = el.dataset.deleteId;
      const s = getLessonStore();
      delete s[id];
      saveLessonStore(s);
      if (getCurrentLessonId() === id) setCurrentLessonId('');
      renderSavedList();
      lmToast('ÏÇ≠Ï†úÎê®');
    });
  });

  // Î†åÎçî Ïãú bulk bar Ï¥àÍ∏∞Ìôî
  $('#lm-bulk-bar').classList.add('hidden');
}

function setupLessonManager() {
  $('#btn-lesson-mgr').addEventListener('click', openLessonModal);
  $('#lm-close').addEventListener('click', closeLessonModal);
  $('#lesson-modal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeLessonModal();
  });

  // Tabs
  $$('.lm-tab').forEach(t => {
    t.addEventListener('click', () => activateLmTab(t.dataset.lmTab));
  });

  // Load & Save
  $('#lm-btn-load').addEventListener('click', () => {
    const text = $('#lm-paste').value;
    if (!text.trim()) { lmToast('‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞Î•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî'); return; }
    const data = parseLessonInput(text);
    if (!data || !data.slides) { lmToast('‚ùå ÌååÏã± Ïã§Ìå® ‚Äî Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî'); return; }
    const id = data.title || ('ÏàòÏóÖ_' + Date.now());
    const store = getLessonStore();
    store[id] = { data, savedAt: Date.now() };
    saveLessonStore(store);
    setCurrentLessonId(id);
    loadLessonData(data);
    closeLessonModal();
    $('#lm-paste').value = '';
    lmToast('‚úÖ "' + (data.title || 'ÏÉà ÏàòÏóÖ') + '" Ï†ÄÏû• & Î°úÎìú ÏôÑÎ£å');
  });

  // Edit save
  $('#lm-btn-save-edit').addEventListener('click', () => {
    const text = $('#lm-edit').value;
    const data = parseLessonInput(text);
    if (!data || !data.slides) { lmToast('‚ùå JSON ÌååÏã± Ïã§Ìå®'); return; }
    const id = data.title || getCurrentLessonId() || ('ÏàòÏóÖ_' + Date.now());
    const store = getLessonStore();
    store[id] = { data, savedAt: Date.now() };
    saveLessonStore(store);
    setCurrentLessonId(id);
    loadLessonData(data);
    closeLessonModal();
    lmToast('‚úÖ ÏàòÏ†ï Ï†ÄÏû• ÏôÑÎ£å');
  });

  // Copy
  $('#lm-btn-copy').addEventListener('click', () => {
    const ta = $('#lm-edit');
    ta.select();
    document.execCommand('copy');
    lmToast('üìã ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨Îê®');
  });

  // ‚îÄ‚îÄ JS ÌååÏùº ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ ‚îÄ‚îÄ
  function handleLessonFile(file) {
    if (!file) return;
    if (!file.name.endsWith('.js')) { lmToast('‚ö†Ô∏è .js ÌååÏùºÎßå ÏßÄÏõêÎê©ÎãàÎã§'); return; }
    const reader = new FileReader();
    reader.onload = (ev) => {
      const text = ev.target.result;
      const data = parseLessonInput(text);
      if (!data || !data.slides) { lmToast('‚ùå ÌååÏã± Ïã§Ìå® ‚Äî Ïò¨Î∞îÎ•∏ Î†àÏä® JS ÌååÏùºÏù∏ÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî'); return; }
      const id = 'usr_' + (data.title || '').replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '_').substring(0, 40) || ('ÏàòÏóÖ_' + Date.now());
      const store = getLessonStore();
      store[id] = { data, savedAt: Date.now() };
      saveLessonStore(store);
      setCurrentLessonId(id);
      loadLessonData(data);
      closeLessonModal();
      lmToast('‚úÖ "' + (data.title || 'ÏÉà ÏàòÏóÖ') + '" Ï†ÄÏû• & Î°úÎìú ÏôÑÎ£å');
    };
    reader.readAsText(file);
  }

  const dropzone = $('#lm-dropzone');
  const fileInput = $('#lm-file-input');

  dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('drag-over');
  });
  dropzone.addEventListener('dragleave', (e) => {
    if (!dropzone.contains(e.relatedTarget)) dropzone.classList.remove('drag-over');
  });
  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('drag-over');
    handleLessonFile(e.dataTransfer.files[0]);
  });
  fileInput.addEventListener('change', (e) => {
    handleLessonFile(e.target.files[0]);
    fileInput.value = '';
  });

  // Keyboard: L to open
  // (added in handleKey)

  // Prevent keyboard shortcuts when modal textarea is focused
  $('#lesson-modal').addEventListener('keydown', (e) => {
    if (e.target.tagName === 'TEXTAREA') e.stopPropagation();
  }, true);

  // ‚îÄ‚îÄ Ï†ïÎ†¨ Î≤ÑÌäº ‚îÄ‚îÄ
  $$('.lm-sort-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      lmSortMode = btn.dataset.sort;
      renderSavedList();
    });
  });

  // ‚îÄ‚îÄ ÏÑ†ÌÉù Ìï¥Ï†ú ‚îÄ‚îÄ
  $('#lm-bulk-deselect').addEventListener('click', () => {
    $('#lm-saved-list').querySelectorAll('.lm-list-check').forEach(cb => {
      cb.checked = false;
      cb.closest('li').classList.remove('lm-selected');
    });
    $('#lm-bulk-bar').classList.add('hidden');
  });

  // ‚îÄ‚îÄ ÏùºÍ¥Ñ ÏÇ≠Ï†ú ‚îÄ‚îÄ
  $('#lm-bulk-delete').addEventListener('click', () => {
    const checked = $('#lm-saved-list').querySelectorAll('.lm-list-check:checked');
    if (!checked.length) return;
    const ids = Array.from(checked).map(cb => cb.dataset.checkId);
    const s = getLessonStore();
    ids.forEach(id => delete s[id]);
    saveLessonStore(s);
    if (ids.includes(getCurrentLessonId())) setCurrentLessonId('');
    renderSavedList();
    lmToast(`üóë ${ids.length}Í∞ú ÏÇ≠Ï†úÎê®`);
  });
}

// ===== LESSON NAV DROPDOWN =====
function extractChapter(title) {
  if (!title) return 'Í∏∞ÌÉÄ';
  // Match patterns: Ch3, Chapter 3, L3, Lesson 3, 3Í≥º, Unit 3, etc.
  const m = title.match(/(?:ch(?:apter)?|l(?:esson)?|unit|Í≥º)\s*(\d+)/i)
    || title.match(/(\d+)\s*Í≥º/);
  if (m) return (m[0].match(/Í≥º/) ? m[1] + 'Í≥º' : m[0]).replace(/\s+/g, ' ');
  return null;
}

function renderLessonNav() {
  const dd = $('#lesson-nav-dropdown');
  const store = getLessonStore();
  const keys = Object.keys(store).sort((a, b) => (store[a].savedAt || 0) - (store[b].savedAt || 0));
  const currentId = getCurrentLessonId();

  if (keys.length === 0) {
    dd.innerHTML = '<div class="lnav-empty">Ï†ÄÏû•Îêú ÏàòÏóÖÏù¥ ÏóÜÏäµÎãàÎã§.<br>üìö Î≤ÑÌäºÏúºÎ°ú ÏàòÏóÖÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.</div>';
    dd.innerHTML += '<div class="lnav-footer"><button id="lnav-manage">üìö ÏàòÏóÖ Í¥ÄÎ¶¨ Ïó¥Í∏∞</button></div>';
    dd.querySelector('#lnav-manage').addEventListener('click', () => { closeLessonNav(); openLessonModal(); });
    return;
  }

  // Group by chapter
  const groups = {};
  const noGroup = [];
  keys.forEach(k => {
    const item = store[k];
    const title = (item.data && item.data.title) || k;
    const ch = (item.data && item.data.chapter) || extractChapter(title);
    if (ch) {
      if (!groups[ch]) groups[ch] = [];
      groups[ch].push({ id: k, item });
    } else {
      noGroup.push({ id: k, item });
    }
  });

  let html = '';
  const groupKeys = Object.keys(groups);
  // If only one group or no groups, skip group labels
  const showGroups = groupKeys.length > 1 || (groupKeys.length === 1 && noGroup.length > 0);

  groupKeys.forEach(ch => {
    if (showGroups) html += `<div class="lnav-group-label">${esc(ch)}</div>`;
    groups[ch].forEach(({ id, item }) => {
      const active = id === currentId ? ' active' : '';
      const slides = (item.data && item.data.slides && item.data.slides.length) || 0;
      const title = (item.data && item.data.title) || id;
      html += `<div class="lnav-item${active}" data-nav-id="${esc(id)}">
        <span>${esc(title)}</span>
        <span class="lnav-slides">${slides}Ïä¨ÎùºÏù¥Îìú</span>
      </div>`;
    });
  });

  if (noGroup.length) {
    if (showGroups) html += `<div class="lnav-group-label">Í∏∞ÌÉÄ</div>`;
    noGroup.forEach(({ id, item }) => {
      const active = id === currentId ? ' active' : '';
      const slides = (item.data && item.data.slides && item.data.slides.length) || 0;
      const title = (item.data && item.data.title) || id;
      html += `<div class="lnav-item${active}" data-nav-id="${esc(id)}">
        <span>${esc(title)}</span>
        <span class="lnav-slides">${slides}Ïä¨ÎùºÏù¥Îìú</span>
      </div>`;
    });
  }

  html += '<div class="lnav-footer"><button id="lnav-manage">üìö ÏàòÏóÖ Í¥ÄÎ¶¨ Ïó¥Í∏∞</button></div>';
  dd.innerHTML = html;

  // Event listeners
  dd.querySelectorAll('.lnav-item').forEach(el => {
    el.addEventListener('click', () => {
      const id = el.dataset.navId;
      const item = getLessonStore()[id];
      if (item && item.data) {
        loadLessonData(item.data);
        setCurrentLessonId(id);
        closeLessonNav();
        lmToast('‚úÖ ' + (item.data.title || id));
      }
    });
  });
  const manageBtn = dd.querySelector('#lnav-manage');
  if (manageBtn) manageBtn.addEventListener('click', () => { closeLessonNav(); openLessonModal(); });
}

function toggleLessonNav() {
  const dd = $('#lesson-nav-dropdown');
  if (dd.classList.contains('open')) {
    closeLessonNav();
  } else {
    renderLessonNav();
    dd.classList.add('open');
  }
}

function closeLessonNav() {
  $('#lesson-nav-dropdown').classList.remove('open');
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('#lesson-nav-wrap')) closeLessonNav();
});

// Wire up title bar button
$('#lesson-title-bar').addEventListener('click', (e) => {
  e.stopPropagation();
  toggleLessonNav();
});

// Load saved lesson on startup (if exists)
function loadSavedOnStartup() {
  const id = getCurrentLessonId();
  if (!id) return false;
  const store = getLessonStore();
  const item = store[id];
  if (item && item.data && item.data.slides) {
    STATE.lesson = item.data;
    return true;
  }
  return false;
}

// ===== AUTO-IMPORT LESSON LIBRARY =====
function importLessonLibrary() {
  const lib = window.LESSON_LIBRARY;
  if (!lib || !lib.length) return;
  const store = getLessonStore();
  let imported = 0;
  // Build set of valid library IDs
  const validIds = new Set();
  lib.forEach(data => {
    if (!data || !data.slides) return;
    const id = 'lib_' + (data.title || '').replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '_').substring(0, 40);
    validIds.add(id);
    if (!store[id]) {
      store[id] = { data, savedAt: Date.now(), source: 'library' };
      imported++;
    }
  });
  // Clean up removed library lessons from cache
  let cleaned = 0;
  Object.keys(store).forEach(id => {
    if (id.startsWith('lib_') && !validIds.has(id)) {
      delete store[id]; cleaned++;
    }
  });
  if (imported > 0 || cleaned > 0) saveLessonStore(store);
  // Reset current lesson if it was removed
  const curId = getCurrentLessonId();
  if (curId && curId.startsWith('lib_') && !validIds.has(curId)) {
    setCurrentLessonId('');
  }
  return imported;
}

// ===== START =====
importLessonLibrary();
// Try loading saved lesson first
if (!loadSavedOnStartup()) {
  // Use first library lesson, or LESSON_DATA fallback, or create fallback
  const lib = window.LESSON_LIBRARY;
  STATE.lesson = (lib && lib.length > 0 ? lib[0] : null) || window.LESSON_DATA || createFallbackLesson();
  // Auto-select the first library lesson as current
  if (lib && lib.length > 0 && STATE.lesson === lib[0]) {
    const id = 'lib_' + (lib[0].title || '').replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '_').substring(0, 40);
    setCurrentLessonId(id);
  }
}
init();
setupLessonManager();
</script>
</body>
</html>
